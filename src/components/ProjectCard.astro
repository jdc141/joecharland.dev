---
interface Props {
  title: string;
  image?: string;
  description: string;
  tech?: string[];
  // tuple [enabled, url]
  github?: [boolean, string];
  // tuple [enabled, url]
  demo?: [boolean, string];
  inProgress?: boolean;
  deployed?: boolean;
  slug?: string;
}

const { title, image, description, tech = [], github, demo, inProgress = false, deployed = false, slug } = Astro.props;
const isComingSoon = slug === 'coming-soon';
const hasDetailPage = slug && slug !== 'coming-soon';
const detailPageUrl = hasDetailPage ? `/projects/${slug}` : (isComingSoon ? '/coming-soon' : null);

// Link tuples: [enabled, url, iconClass, label]
const links: Array<[boolean, string, string, string]> = [
  [github?.[0] ?? false, github?.[1] ?? '', 'fab fa-github', `View ${title} on GitHub`],
  [demo?.[0] ?? false, demo?.[1] ?? '', 'fas fa-external-link-alt', `View ${title} live`],
];

const isClickable = !!detailPageUrl;
---

<article 
  class={`bg-gray-800/50 border border-gray-700 rounded-lg overflow-hidden hover:border-blue-500 transition-all duration-300 flex flex-col h-full ${isClickable ? 'cursor-pointer' : ''}`} 
  data-detail-url={detailPageUrl ?? undefined}
  role={isClickable ? 'button' : undefined}
  tabindex={isClickable ? 0 : undefined}
>
  {image ? (
    <img 
      src={image} 
      alt={title} 
      class="w-full object-cover h-48 bg-gray-700"
      loading="lazy"
    />
  ) : (
    <div class="w-full h-48 bg-gradient-to-br from-blue-600/20 to-purple-600/20 flex items-center justify-center">
      <i class="fas fa-code text-4xl text-gray-600"></i>
    </div>
  )}
  
  <div class="p-6 flex flex-col flex-grow">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-xl font-bold text-white">{title}</h3>
      {inProgress && (
        <span class="bg-blue-500/20 text-blue-300 text-xs px-2 py-1 rounded-full font-medium border border-blue-500/30">
          ðŸš§ Building
        </span>
      )}
    </div>
    <p class="text-gray-300 text-sm mb-4 flex-grow">{description}</p>
    
    {tech.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-4">
        {tech.map(t => (
          <span class="bg-gray-700/70 text-blue-300 text-xs px-3 py-1 rounded-full font-medium">
            {t}
          </span>
        ))}
      </div>
    )}
    
    {isClickable ? (
      <div class="flex items-center justify-between w-full text-lg">
        <div class="flex gap-3 items-center">
          {links.map(([enabled, url, icon, label]) => enabled && url && (
            <a 
              href={url} 
              target="_blank" 
              rel="noopener noreferrer"
              class="external-link hover:text-blue-400 transition z-20 relative cursor-pointer"
              aria-label={label}>
              <i class={icon}></i>
            </a>
          ))}
        </div>
        <div class="text-blue-400 text-sm font-medium flex items-center gap-1 group-hover:text-blue-300 transition">
          <span>{isComingSoon ? 'Peek Inside' : 'View Details'}</span>
          <i class="fas fa-arrow-right text-xs arrow-wave"></i>
        </div>
      </div>
    ) : (
      <div class="flex items-center text-lg">
        {links.map(([enabled, url, icon, label], idx) => enabled && url && (
          <a 
            href={url} 
            target="_blank" 
            rel="noopener noreferrer"
            class={`hover:text-blue-400 transition ${idx > 0 ? 'ml-3' : ''}`}
            aria-label={label}>
            <i class={icon}></i>
          </a>
        ))}
      </div>
    )}
  </div>
</article>

<script>
  // Navigate the card when it's clickable, but allow external links to open in new tabs
  const cards = document.querySelectorAll<HTMLElement>('[data-detail-url]');
  cards.forEach(card => {
    const url = card.dataset.detailUrl;
    if (!url) return;

    const navigate = () => { window.location.href = url; };

    card.addEventListener('click', (e: MouseEvent) => {
      if ((e.target as HTMLElement).closest('.external-link')) return;
      navigate();
    });

    card.addEventListener('keydown', (e: KeyboardEvent) => {
      if ((e.target as HTMLElement).closest('.external-link')) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        navigate();
      }
    });
  });

  document.querySelectorAll<HTMLElement>('.external-link').forEach(link => {
    link.addEventListener('click', (e: MouseEvent) => {
      e.stopPropagation();
    });
  });
</script>
